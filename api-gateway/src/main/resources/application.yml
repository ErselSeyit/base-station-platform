spring:
  application:
    name: api-gateway
  threads:
    virtual:
      enabled: true
  data:
    redis:
      reactive:
        host: ${SPRING_DATA_REDIS_HOST:redis}
        port: ${SPRING_DATA_REDIS_PORT:6379}
  cloud:
    gateway:
      routes:
        - id: base-station-service
          uri: ${ROUTE_BASESTATION_URL:http://base-station-service:8081}
          predicates:
            - Path=/api/v1/stations/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                redis-rate-limiter.requestedTokens: 1
        - id: monitoring-service
          uri: ${ROUTE_MONITORING_URL:http://monitoring-service:8082}
          predicates:
            - Path=/api/v1/metrics/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                redis-rate-limiter.requestedTokens: 1
        - id: alerts-service
          uri: ${ROUTE_MONITORING_URL:http://monitoring-service:8082}
          predicates:
            - Path=/api/v1/alerts/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                redis-rate-limiter.requestedTokens: 1
        - id: diagnostics-service
          uri: ${ROUTE_MONITORING_URL:http://monitoring-service:8082}
          predicates:
            - Path=/api/v1/diagnostics,/api/v1/diagnostics/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 30
                redis-rate-limiter.burstCapacity: 60
                redis-rate-limiter.requestedTokens: 1
        - id: notification-service
          uri: ${ROUTE_NOTIFICATION_URL:http://notification-service:8083}
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 30
                redis-rate-limiter.burstCapacity: 60
                redis-rate-limiter.requestedTokens: 1
        - id: auth-service
          uri: ${ROUTE_AUTH_URL:http://auth-service:8084}
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                redis-rate-limiter.requestedTokens: 1
        - id: reports-service
          uri: ${ROUTE_AI_DIAGNOSTIC_URL:http://ai-diagnostic:9091}
          predicates:
            - Path=/api/reports/**
          filters:
            - RewritePath=/api/reports/(?<segment>.*), /reports/${segment}
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 5
                redis-rate-limiter.burstCapacity: 10
                redis-rate-limiter.requestedTokens: 1

server:
  port: 8080
  # Request size limits to prevent abuse
  max-http-request-header-size: 16KB
  netty:
    max-initial-line-length: 8192
    max-chunk-size: 65536

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
  tracing:
    sampling:
      # Default to 10% sampling in production (configurable via env var)
      probability: ${TRACING_SAMPLE_PROBABILITY:0.1}
  zipkin:
    tracing:
      endpoint: ${MANAGEMENT_TRACING_ENDPOINT:http://zipkin:9411/api/v2/spans}

logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: INFO
    com.huawei: INFO

cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://frontend:80}

jwt:
  secret: ${JWT_SECRET:}

security:
  internal:
    secret: ${SECURITY_INTERNAL_SECRET:}
  headers:
    # HSTS - only enable with HTTPS in production
    hsts:
      enabled: ${SECURITY_HSTS_ENABLED:false}
      max-age: ${SECURITY_HSTS_MAX_AGE:31536000}
    # Content Security Policy
    csp:
      enabled: ${SECURITY_CSP_ENABLED:true}
    # X-Frame-Options (DENY, SAMEORIGIN)
    frame-options: ${SECURITY_FRAME_OPTIONS:DENY}
  actuator:
    # Allowed IPs for actuator endpoints (comma-separated, supports CIDR)
    allowed-ips: ${SECURITY_ACTUATOR_IPS:127.0.0.1,::1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16}
  https:
    # Enable HTTPS enforcement in production
    enforce: ${SECURITY_HTTPS_ENFORCE:false}
    port: ${SECURITY_HTTPS_PORT:443}
