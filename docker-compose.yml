# Base Station Operations & Maintenance Platform - Docker Compose
#
# SECURITY WARNING:
# This file uses default passwords for development convenience.
# For production deployment, ALWAYS set environment variables with strong passwords.
# 
# To use environment variables:
# 1. Copy .env.example to .env
# 2. Update .env with strong, unique passwords
# 3. Docker Compose will automatically use values from .env file
#
# Default values (used if .env not set):
# - PostgreSQL passwords: "postgres"
# - RabbitMQ credentials: "admin/admin"
# - These defaults are INSECURE and should NOT be used in production
#
services:
  postgres-basestation:
    image: postgres:18-alpine
    container_name: postgres-basestation
    environment:
      POSTGRES_DB: ${POSTGRES_BASESTATION_DB:-basestationdb}
      POSTGRES_USER: ${POSTGRES_BASESTATION_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_BASESTATION_PASSWORD:-postgres}
    ports:
      - "5434:5432"
    volumes:
      - postgres-basestation-data:/var/lib/postgresql/data
    networks:
      - database-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  postgres-notification:
    image: postgres:18-alpine
    container_name: postgres-notification
    environment:
      POSTGRES_DB: ${POSTGRES_NOTIFICATION_DB:-notificationdb}
      POSTGRES_USER: ${POSTGRES_NOTIFICATION_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_NOTIFICATION_PASSWORD:-postgres}
    ports:
      - "5435:5432"
    volumes:
      - postgres-notification-data:/var/lib/postgresql/data
    networks:
      - database-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  postgres-auth:
    image: postgres:18-alpine
    container_name: postgres-auth
    environment:
      POSTGRES_DB: ${POSTGRES_AUTH_DB:-authdb}
      POSTGRES_USER: ${POSTGRES_AUTH_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_AUTH_PASSWORD:-postgres}
    ports:
      - "5436:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
    networks:
      - database-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  mongodb:
    image: mongo:8.2
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-admin}
      MONGO_INITDB_DATABASE: monitoringdb
    ports:
      - "27018:27017"
    volumes:
      - mongodb-data:/data/db
    networks:
      - database-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1024M
        reservations:
          cpus: '0.75'
          memory: 512M
    healthcheck:
      test: ["CMD", "mongosh", "--username", "${MONGODB_USER:-admin}", "--password", "${MONGODB_PASSWORD:-admin}", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  redis:
    image: redis:8-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: keycloak
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres-auth:5432/${POSTGRES_AUTH_DB:-authdb}
      KC_DB_USERNAME: ${POSTGRES_AUTH_USER:-postgres}
      KC_DB_PASSWORD: ${POSTGRES_AUTH_PASSWORD:-postgres}
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      JAVA_OPTS: "-Xms384m -Xmx768m -XX:MaxMetaspaceSize=192m -XX:+UseG1GC"
    command:
      - start-dev
      - --import-realm
    ports:
      - "8090:8080"
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    networks:
      - app-network
      - database-network
      - frontend-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 384M
    depends_on:
      postgres-auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  rabbitmq:
    image: rabbitmq:4-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-admin}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  zipkin:
    image: openzipkin/zipkin:3.5
    container_name: zipkin
    environment:
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:+UseG1GC"
    ports:
      - "9411:9411"
    networks:
      - monitoring-network
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - monitoring-network
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    depends_on:
      - prometheus

  eureka-server:
    build:
      context: .
      dockerfile: eureka-server/Dockerfile
    container_name: eureka-server
    environment:
      JAVA_OPTS: "-Xms128m -Xmx256m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    ports:
      - "8762:8761"
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
        reservations:
          cpus: '0.25'
          memory: 192M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  base-station-service:
    build:
      context: .
      dockerfile: base-station-service/Dockerfile
    container_name: base-station-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-basestation:5432/${POSTGRES_BASESTATION_DB:-basestationdb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_BASESTATION_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_BASESTATION_PASSWORD:-postgres}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      MANAGEMENT_TRACING_ENDPOINT: http://zipkin:9411
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET environment variable is required}
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication"
    ports:
      - "8084:8081"
    depends_on:
      postgres-basestation:
        condition: service_healthy
      eureka-server:
        condition: service_started
    networks:
      - app-network
      - database-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 640M
        reservations:
          cpus: '0.5'
          memory: 320M

  monitoring-service:
    build:
      context: .
      dockerfile: monitoring-service/Dockerfile
    container_name: monitoring-service
    environment:
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_DATABASE: monitoringdb
      SPRING_DATA_MONGODB_USERNAME: ${MONGODB_USER:-admin}
      SPRING_DATA_MONGODB_PASSWORD: ${MONGODB_PASSWORD:-admin}
      SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE: admin
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-admin}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-admin}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET environment variable is required}
      JAVA_OPTS: "-Xms512m -Xmx768m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication"
    ports:
      - "8085:8082"
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_started
    networks:
      - app-network
      - database-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 960M
        reservations:
          cpus: '0.5'
          memory: 480M

  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: notification-service
    command: ["java", "-Dspring.main.allow-circular-references=true", "-jar", "/app/app.jar"]
    environment:
      SPRING_MAIN_ALLOW_CIRCULAR_REFERENCES: "true"
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-notification:5432/${POSTGRES_NOTIFICATION_DB:-notificationdb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_NOTIFICATION_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_NOTIFICATION_PASSWORD:-postgres}
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-admin}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-admin}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET environment variable is required}
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    ports:
      - "8086:8083"
    depends_on:
      postgres-notification:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_started
    networks:
      - app-network
      - database-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 640M
        reservations:
          cpus: '0.5'
          memory: 320M

  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: auth-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-auth:5432/${POSTGRES_AUTH_DB:-authdb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_AUTH_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_AUTH_PASSWORD:-postgres}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET environment variable is required}
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET environment variable is required}
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    ports:
      - "8087:8084"
    depends_on:
      postgres-auth:
        condition: service_healthy
      eureka-server:
        condition: service_started
    networks:
      - app-network
      - database-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 640M
        reservations:
          cpus: '0.5'
          memory: 320M

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      MANAGEMENT_TRACING_ENDPOINT: http://zipkin:9411
      JWT_SECRET: ${JWT_SECRET}
      JWT_SIMULATE_VALIDATION: "true"
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET environment variable is required}
      JAVA_OPTS: "-Xms512m -Xmx1024m -XX:MaxMetaspaceSize=192m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication"
    ports:
      - "8080:8080"
    depends_on:
      - base-station-service
      - monitoring-service
      - notification-service
      - auth-service
      - eureka-server
      - redis
    networks:
      - frontend-network
      - app-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1280M
        reservations:
          cpus: '0.75'
          memory: 640M

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - frontend-network
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

volumes:
  postgres-basestation-data:
  postgres-notification-data:
  postgres-auth-data:
  mongodb-data:
  redis-data:
  rabbitmq-data:
  prometheus-data:
  grafana-data:

networks:
  # Public-facing network - Only gateway and frontend
  frontend-network:
    driver: bridge

  # Application services network - Gateway communicates with services
  app-network:
    driver: bridge
    internal: false  # Gateway needs external access

  # Database network - Isolated for data layer
  database-network:
    driver: bridge
    internal: false  # Changed to false to allow service-to-database communication

  # Monitoring network - Observability stack
  monitoring-network:
    driver: bridge
