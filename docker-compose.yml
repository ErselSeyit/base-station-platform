# Base Station Operations & Maintenance Platform - Docker Compose
#
# Production-optimized stack:
#   - Single PostgreSQL with multiple databases
#   - Direct service routing (no Eureka)
#   - HMAC authentication (no Keycloak)
#   - Distributed tracing with Zipkin
#
# Container count: 11 services
# Required environment variables - copy .env.example to .env and configure
#
# REQUIRED VARIABLES (will fail without these):
#   POSTGRES_USER, POSTGRES_PASSWORD
#   MONGODB_USER, MONGODB_PASSWORD
#   RABBITMQ_USER, RABBITMQ_PASSWORD
#   GRAFANA_PASSWORD
#   JWT_SECRET (min 32 chars)
#   SECURITY_INTERNAL_SECRET
#
services:
  # ============================================
  # DATABASES
  # ============================================
  postgres:
    image: postgres:18-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_MULTIPLE_DATABASES: basestationdb,notificationdb,authdb
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh:ro
    networks:
      - database-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mongodb:
    image: mongo:8.2
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:?MONGODB_USER is required}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:?MONGODB_PASSWORD is required}
      MONGO_INITDB_DATABASE: monitoringdb
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
    networks:
      - database-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:8-alpine
    container_name: redis
    # Note: Only set password via config if REDIS_PASSWORD is non-empty
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:4-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:?RABBITMQ_USER is required}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD is required}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # OBSERVABILITY
  # ============================================
  zipkin:
    image: openzipkin/zipkin:3.5
    container_name: zipkin
    environment:
      JAVA_OPTS: "-Xms128m -Xmx256m -XX:+UseG1GC"
    ports:
      - "9411:9411"
    networks:
      - monitoring-network
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9411/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
    networks:
      - monitoring-network
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:?GRAFANA_PASSWORD is required}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    depends_on:
      - prometheus

  # ============================================
  # APPLICATION SERVICES
  # ============================================
  ai-diagnostic:
    build:
      context: ./ai-diagnostic
      dockerfile: Dockerfile
    container_name: ai-diagnostic
    environment:
      DIAGNOSTIC_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET is required}
      # ZIPKIN_ENDPOINT: http://zipkin:9411/api/v2/spans  # Disabled - uncomment when zipkin is running
      API_GATEWAY_URL: http://api-gateway:8080
      AUTH_ADMIN_PASSWORD: ${AUTH_ADMIN_PASSWORD:?AUTH_ADMIN_PASSWORD is required}
    ports:
      - "9091:9091"
    networks:
      - app-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9091/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  base-station-service:
    build:
      context: .
      dockerfile: base-station-service/Dockerfile
    container_name: base-station-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/basestationdb
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:?POSTGRES_USER is required}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 10
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 5
      SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: 30000
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO:-update}
      MANAGEMENT_TRACING_ENDPOINT: http://zipkin:9411
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET is required}
      JAVA_OPTS: "-Xms256m -Xmx384m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network
      - database-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  monitoring-service:
    build:
      context: .
      dockerfile: monitoring-service/Dockerfile
    container_name: monitoring-service
    environment:
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_DATABASE: monitoringdb
      SPRING_DATA_MONGODB_USERNAME: ${MONGODB_USER:?MONGODB_USER is required}
      SPRING_DATA_MONGODB_PASSWORD: ${MONGODB_PASSWORD:?MONGODB_PASSWORD is required}
      SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE: admin
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:?RABBITMQ_USER is required}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD is required}
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET is required}
      DIAGNOSTIC_SERVICE_URL: http://ai-diagnostic:9091
      DIAGNOSTIC_SERVICE_ENABLED: "true"
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8082:8082"
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ai-diagnostic:
        condition: service_healthy
    networks:
      - app-network
      - database-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 640M

  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: notification-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/notificationdb
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:?POSTGRES_USER is required}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 10
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 5
      SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: 30000
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO:-update}
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:?RABBITMQ_USER is required}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD is required}
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET is required}
      JAVA_OPTS: "-Xms256m -Xmx384m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8083:8083"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network
      - database-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: auth-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/authdb
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:?POSTGRES_USER is required}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 10
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 5
      SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: 30000
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO:-update}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_COOKIE_SECURE: "false"  # HTTP development mode - set to true for HTTPS production
      AUTH_ADMIN_PASSWORD: ${AUTH_ADMIN_PASSWORD:?AUTH_ADMIN_PASSWORD is required}
      BRIDGE_USERNAME: ${BRIDGE_USERNAME:-bridge-user}
      AUTH_SERVICE_ACCOUNTS: ${BRIDGE_USERNAME:-bridge-user}
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET is required}
      JAVA_OPTS: "-Xms256m -Xmx384m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8084:8084"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network
      - database-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    environment:
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      MANAGEMENT_TRACING_ENDPOINT: http://zipkin:9411
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${SECURITY_INTERNAL_SECRET:?SECURITY_INTERNAL_SECRET is required}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      # Direct service URLs
      ROUTE_BASESTATION_URL: http://base-station-service:8081
      ROUTE_MONITORING_URL: http://monitoring-service:8082
      ROUTE_NOTIFICATION_URL: http://notification-service:8083
      ROUTE_AUTH_URL: http://auth-service:8084
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8080:8080"
    depends_on:
      - base-station-service
      - monitoring-service
      - notification-service
      - auth-service
      - redis
    networks:
      - frontend-network
      - app-network
      - monitoring-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 640M

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    environment:
      API_URL: ${API_URL:-http://api-gateway:8080}
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - frontend-network
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 64M

  # ============================================
  # EDGE BRIDGE (optional - for MIPS device integration)
  # ============================================
  edge-bridge:
    build:
      context: ./edge-bridge
      dockerfile: Dockerfile
    container_name: edge-bridge
    environment:
      STATION_ID: ${EDGE_STATION_ID:-BS-001}
      CLOUD_BASE_URL: http://api-gateway:8080
      BRIDGE_USERNAME: ${BRIDGE_USERNAME:?BRIDGE_USERNAME is required}
      BRIDGE_PASSWORD: ${AUTH_ADMIN_PASSWORD:?AUTH_ADMIN_PASSWORD is required}
      DEVICE_HOST: ${DEVICE_HOST:-device-simulator}
      DEVICE_PORT: ${DEVICE_PORT:-9999}
    depends_on:
      - api-gateway
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 64M
    profiles:
      - edge  # Only start with: docker-compose --profile edge up

  device-simulator:
    build:
      context: ./ai-diagnostic/virtual-basestation
      dockerfile: Dockerfile
    container_name: device-simulator
    environment:
      STATION_ID: ${MIPS_STATION_ID:-MIPS-BS-001}
    ports:
      - "9999:9999"
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
    profiles:
      - edge  # Only start with: docker-compose --profile edge up

  # ============================================
  # VIRTUAL 5G STATION (realistic 5G NR simulator)
  # ============================================
  virtual-5g-station:
    build:
      context: ./virtual-5g-station
      dockerfile: Dockerfile
    container_name: virtual-5g-station
    environment:
      STATION_ID: VIRT-001
      STATION_NAME: Virtual-5G-Istanbul
      STATION_REGION: ISTANBUL
      STATION_CITY: Simulation
      API_GATEWAY_URL: http://api-gateway:8080
      STATION_USERNAME: admin
      STATION_PASSWORD: ${AUTH_ADMIN_PASSWORD:?AUTH_ADMIN_PASSWORD is required}
    ports:
      - "8090:8090"
    depends_on:
      - api-gateway
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8090/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - 5g  # Start with: docker-compose --profile 5g up

volumes:
  postgres-data:
  mongodb-data:
  redis-data:
  rabbitmq-data:
  prometheus-data:
  grafana-data:

networks:
  frontend-network:
    driver: bridge
  app-network:
    driver: bridge
  database-network:
    driver: bridge
  monitoring-network:
    driver: bridge
