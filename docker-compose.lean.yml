# Base Station Platform - Production-Grade Lean Stack
#
# Optimizations:
#   - Single PostgreSQL with multiple databases (3â†’1)
#   - No Eureka (uses Docker/K8s DNS for service discovery)
#   - No Keycloak (uses auth-service with HMAC signing)
#   - Keeps Zipkin (distributed tracing for multi-station debugging)
#   - Keeps Grafana (production dashboards)
#
# Security: HMAC-SHA256 request signing for API authentication
#
# Original: 15 containers, ~8GB memory
# Lean:     11 containers, ~5GB memory (33% reduction)
#
services:
  # ============================================
  # DATABASES
  # ============================================
  postgres:
    image: postgres:18-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Required}
      POSTGRES_MULTIPLE_DATABASES: basestationdb,notificationdb,authdb
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh:ro
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mongodb:
    image: mongo:8.2
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:?Required}
      MONGO_INITDB_DATABASE: monitoringdb
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "mongosh", "--username", "${MONGODB_USER:-admin}", "--password", "${MONGODB_PASSWORD}", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:8-alpine
    container_name: redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:4-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:?Required}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # OBSERVABILITY
  # ============================================
  zipkin:
    image: openzipkin/zipkin:3.5
    container_name: zipkin
    environment:
      JAVA_OPTS: "-Xms128m -Xmx256m -XX:+UseG1GC"
    ports:
      - "9411:9411"
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:?Required}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    depends_on:
      - prometheus

  # ============================================
  # APPLICATION SERVICES (direct routing, no Eureka)
  # ============================================
  ai-diagnostic:
    build:
      context: ./ai-diagnostic
      dockerfile: Dockerfile
    container_name: ai-diagnostic
    ports:
      - "9091:9091"
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  base-station-service:
    build:
      context: .
      dockerfile: base-station-service/Dockerfile
    container_name: base-station-service
    environment:
      SPRING_PROFILES_ACTIVE: lean
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/basestationdb
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:?Required}
      EUREKA_CLIENT_ENABLED: "false"
      MANAGEMENT_TRACING_ENDPOINT: http://zipkin:9411
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${HMAC_SECRET:?Required}
      JAVA_OPTS: "-Xms256m -Xmx384m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  monitoring-service:
    build:
      context: .
      dockerfile: monitoring-service/Dockerfile
    container_name: monitoring-service
    environment:
      SPRING_PROFILES_ACTIVE: lean
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_DATABASE: monitoringdb
      SPRING_DATA_MONGODB_USERNAME: ${MONGODB_USER:-admin}
      SPRING_DATA_MONGODB_PASSWORD: ${MONGODB_PASSWORD:?Required}
      SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE: admin
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-admin}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:?Required}
      EUREKA_CLIENT_ENABLED: "false"
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${HMAC_SECRET:?Required}
      DIAGNOSTIC_SERVICE_URL: http://ai-diagnostic:9091
      DIAGNOSTIC_SERVICE_ENABLED: "true"
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8082:8082"
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ai-diagnostic:
        condition: service_healthy
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 640M

  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: notification-service
    environment:
      SPRING_PROFILES_ACTIVE: lean
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/notificationdb
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:?Required}
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-admin}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:?Required}
      EUREKA_CLIENT_ENABLED: "false"
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${HMAC_SECRET:?Required}
      JAVA_OPTS: "-Xms256m -Xmx384m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8083:8083"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: auth-service
    environment:
      SPRING_PROFILES_ACTIVE: lean
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/authdb
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:?Required}
      EUREKA_CLIENT_ENABLED: "false"
      HMAC_SECRET: ${HMAC_SECRET:?Required}
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${HMAC_SECRET:?Required}
      JAVA_OPTS: "-Xms256m -Xmx384m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8084:8084"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: lean
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis}
      MANAGEMENT_TRACING_ENDPOINT: http://zipkin:9411
      HMAC_SECRET: ${HMAC_SECRET:?Required}
      SECURITY_INTERNAL_ENABLED: "true"
      SECURITY_INTERNAL_SECRET: ${HMAC_SECRET:?Required}
      # Direct service URLs (no Eureka discovery)
      ROUTE_BASESTATION_URL: http://base-station-service:8081
      ROUTE_MONITORING_URL: http://monitoring-service:8082
      ROUTE_NOTIFICATION_URL: http://notification-service:8083
      ROUTE_AUTH_URL: http://auth-service:8084
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
    ports:
      - "8080:8080"
    depends_on:
      - base-station-service
      - monitoring-service
      - notification-service
      - auth-service
      - redis
    networks:
      - frontend
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 640M

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - frontend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 64M

volumes:
  postgres-data:
  mongodb-data:
  redis-data:
  rabbitmq-data:
  prometheus-data:
  grafana-data:

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
