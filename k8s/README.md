# Kubernetes Deployment with Fabric8

This directory contains **infrastructure-only** Kubernetes manifests. Service manifests are auto-generated by Eclipse JKube (Fabric8).

## What's in This Directory

- `namespace.yaml` - Namespace for the platform
- `generate-secrets.sh` - **Script to dynamically generate secure secrets** (RECOMMENDED)
- `secrets.yaml.example` - Example secrets file (DO NOT USE IN PRODUCTION)

## What's NOT in This Directory

**Service manifests are auto-generated** by Fabric8/JKube from your Spring Boot configuration.

Previously, this directory contained manual YAML files for:
- api-gateway.yaml
- auth-service.yaml
- base-station-service.yaml
- eureka-server.yaml
- monitoring-service.yaml
- notification-service.yaml
- And all database/infrastructure services

**These have been removed** because Fabric8 generates them automatically from:
- `application.yml` configuration
- Maven plugin configuration
- Optional `src/main/jkube/` fragments

## Deployment Workflow

### 1. Apply Infrastructure (Manual - One Time)

```bash
# Create namespace
kubectl apply -f k8s/namespace.yaml

# Generate and apply secrets (RECOMMENDED - dynamically generated)
./k8s/generate-secrets.sh | kubectl apply -f -

# OR for development only (NOT recommended for production):
# kubectl apply -f k8s/secrets.yaml.example
```

**Security Best Practice:**
- Use `generate-secrets.sh` for dynamic secret generation
- Secrets are generated with `openssl rand` for cryptographic randomness
- Each deployment gets unique passwords
- For production, consider using Sealed Secrets or External Secrets Operator

### 2. Generate Service Manifests (Fabric8)

```bash
# Generate Kubernetes YAML for all services
mvn k8s:resource

# Generated manifests appear in:
# <service-name>/target/classes/META-INF/jkube/kubernetes/
```

### 3. Build Container Images

```bash
# Build Docker images for all services
mvn k8s:build

# Images tagged as: <groupId>/<artifactId>:<version>
```

### 4. Deploy to Kubernetes

```bash
# Deploy everything
mvn k8s:apply

# Or do all steps at once:
mvn clean package k8s:build k8s:resource k8s:apply
```

### 5. Undeploy

```bash
mvn k8s:undeploy
```

## Why Fabric8?

### Before (Manual YAML)
- 16 YAML files to maintain manually
- Duplication between `application.yml` and K8s manifests
- Easy to forget updating K8s when changing app config
- 200+ lines per service deployment manifest

### After (Fabric8)
- 2 infrastructure YAML files (namespace, secrets)
- Single source of truth: `application.yml`
- Auto-generated health/readiness probes from Spring Actuator
- Consistent configuration across environments

## Customizing Generated Manifests

Create `src/main/jkube/` directory in any service to override defaults:

**Example: `base-station-service/src/main/jkube/deployment.yml`**
```yaml
spec:
  template:
    spec:
      containers:
        - env:
            - name: SPRING_PROFILES_ACTIVE
              value: kubernetes
            - name: CUSTOM_ENV_VAR
              value: custom-value
```

## Database Manifests

For production, databases should use:
- **StatefulSets** (not Deployments)
- **PersistentVolumeClaims**
- **Separate configuration** from application services

These are typically managed separately or via Helm charts.

## Common Commands

```bash
# Check deployment status
kubectl get all -n basestation-platform

# View generated manifests
ls */target/classes/META-INF/jkube/kubernetes/

# Watch logs
mvn k8s:log -Djkube.log.follow=true

# Port forward to service
kubectl port-forward svc/base-station-service 8081:8081 -n basestation-platform
```

## References

- [Eclipse JKube Documentation](https://www.eclipse.dev/jkube/docs/)
- [Fabric8 Configuration Guide](docs/FABRIC8_KUBERNETES.md)
- [Spring Boot on Kubernetes](https://spring.io/guides/gs/spring-boot-kubernetes/)
