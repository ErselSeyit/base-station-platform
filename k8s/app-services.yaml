# ============================================================================
# Base Station Platform - Application Services
# ============================================================================
#
# SECRETS MANAGEMENT:
# -------------------
# Secrets are NOT stored in this file (that would be insecure).
#
# To create secrets:
#   1. Copy .env.example to .env and fill in your values
#   2. Run: ./create-secrets.sh
#
# Or use SealedSecrets for GitOps:
#   kubeseal --format=yaml < secret.yaml > sealed-secret.yaml
#
# Required secrets (create before deploying):
#   - auth-credentials     (admin-username, admin-password, operator-*)
#   - edge-bridge-secret   (username, password)
#   - jwt-secret           (secret)
#   - security-internal-secret (secret)
#   - postgres-secrets     (username, password)
#   - mongodb-secret       (username, password)
#   - rabbitmq-secret      (username, password)
#   - grafana-secret       (admin-password)
#
# ============================================================================

---
# ============================================================================
# Application Services
# ============================================================================

# Auth Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: basestation-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      automountServiceAccountToken: false
      containers:
      - name: auth-service
        image: base-station-platform-auth-service:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8084
        env:
        - name: SPRING_DATASOURCE_URL
          value: jdbc:postgresql://postgres:5432/authdb
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: postgres-secrets
              key: username
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secrets
              key: password
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: secret
        - name: SECURITY_INTERNAL_SECRET
          valueFrom:
            secretKeyRef:
              name: security-internal-secret
              key: secret
        # Auth user configuration (DataLoader creates/updates users on startup)
        - name: AUTH_ADMIN_USERNAME
          valueFrom:
            secretKeyRef:
              name: auth-credentials
              key: admin-username
        - name: AUTH_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: auth-credentials
              key: admin-password
        - name: AUTH_BRIDGE_USERNAME
          valueFrom:
            secretKeyRef:
              name: auth-credentials
              key: operator-username
        - name: SPRING_JPA_HIBERNATE_DDL_AUTO
          value: "update"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8084
          initialDelaySeconds: 90
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8084
          initialDelaySeconds: 60
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8084
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 30
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
            ephemeral-storage: "2Gi"
          requests:
            cpu: "500m"
            memory: 512Mi
            ephemeral-storage: "1Gi"
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: basestation-platform
spec:
  selector:
    app: auth-service
  ports:
  - port: 8084
    targetPort: 8084
---
# Base Station Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: base-station-service
  namespace: basestation-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: base-station-service
  template:
    metadata:
      labels:
        app: base-station-service
    spec:
      automountServiceAccountToken: false
      containers:
      - name: base-station-service
        image: base-station-platform-base-station-service:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8081
        env:
        - name: SPRING_DATASOURCE_URL
          value: jdbc:postgresql://postgres:5432/basestationdb
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: postgres-secrets
              key: username
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secrets
              key: password
        - name: SECURITY_INTERNAL_SECRET
          valueFrom:
            secretKeyRef:
              name: security-internal-secret
              key: secret
        - name: MANAGEMENT_TRACING_ENDPOINT
          value: http://zipkin:9411
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 90
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 30
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
            ephemeral-storage: "2Gi"
          requests:
            cpu: "500m"
            memory: 512Mi
            ephemeral-storage: "1Gi"
---
apiVersion: v1
kind: Service
metadata:
  name: base-station-service
  namespace: basestation-platform
spec:
  selector:
    app: base-station-service
  ports:
  - port: 8081
    targetPort: 8081
---
# Monitoring Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: monitoring-service
  namespace: basestation-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: monitoring-service
  template:
    metadata:
      labels:
        app: monitoring-service
    spec:
      automountServiceAccountToken: false
      containers:
      - name: monitoring-service
        image: base-station-platform-monitoring-service:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8082
        env:
        - name: SPRING_DATA_MONGODB_HOST
          value: mongodb
        - name: SPRING_DATA_MONGODB_PORT
          value: "27017"
        - name: SPRING_DATA_MONGODB_DATABASE
          value: monitoringdb
        - name: SPRING_DATA_MONGODB_USERNAME
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: username
        - name: SPRING_DATA_MONGODB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: password
        - name: SPRING_RABBITMQ_HOST
          value: rabbitmq
        - name: SPRING_RABBITMQ_USERNAME
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: username
        - name: SPRING_RABBITMQ_PASSWORD
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: password
        - name: SECURITY_INTERNAL_SECRET
          valueFrom:
            secretKeyRef:
              name: security-internal-secret
              key: secret
        - name: DIAGNOSTIC_SERVICE_URL
          value: http://ai-diagnostic:9091
        - name: DIAGNOSTIC_SERVICE_ENABLED
          value: "true"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8082
          initialDelaySeconds: 90
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8082
          initialDelaySeconds: 60
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8082
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 30
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
            ephemeral-storage: "2Gi"
          requests:
            cpu: "500m"
            memory: 512Mi
            ephemeral-storage: "1Gi"
---
apiVersion: v1
kind: Service
metadata:
  name: monitoring-service
  namespace: basestation-platform
spec:
  selector:
    app: monitoring-service
  ports:
  - port: 8082
    targetPort: 8082
---
# Notification Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service
  namespace: basestation-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notification-service
  template:
    metadata:
      labels:
        app: notification-service
    spec:
      automountServiceAccountToken: false
      containers:
      - name: notification-service
        image: base-station-platform-notification-service:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8083
        env:
        - name: SPRING_DATASOURCE_URL
          value: jdbc:postgresql://postgres:5432/notificationdb
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: postgres-secrets
              key: username
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secrets
              key: password
        - name: SPRING_RABBITMQ_HOST
          value: rabbitmq
        - name: SPRING_RABBITMQ_USERNAME
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: username
        - name: SPRING_RABBITMQ_PASSWORD
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: password
        - name: SECURITY_INTERNAL_SECRET
          valueFrom:
            secretKeyRef:
              name: security-internal-secret
              key: secret
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8083
          initialDelaySeconds: 90
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8083
          initialDelaySeconds: 60
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8083
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 30
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
            ephemeral-storage: "2Gi"
          requests:
            cpu: "500m"
            memory: 512Mi
            ephemeral-storage: "1Gi"
---
apiVersion: v1
kind: Service
metadata:
  name: notification-service
  namespace: basestation-platform
spec:
  selector:
    app: notification-service
  ports:
  - port: 8083
    targetPort: 8083
---
# AI Diagnostic Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-diagnostic
  namespace: basestation-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-diagnostic
  template:
    metadata:
      labels:
        app: ai-diagnostic
    spec:
      automountServiceAccountToken: false
      containers:
      - name: ai-diagnostic
        image: base-station-platform-ai-diagnostic:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9091
        env:
        # Cloud integration for bidirectional AI problem-solving
        - name: CLOUD_URL
          value: "http://api-gateway:8080"
        - name: CLOUD_USER
          valueFrom:
            secretKeyRef:
              name: auth-credentials
              key: username
        - name: CLOUD_PASSWORD
          valueFrom:
            secretKeyRef:
              name: auth-credentials
              key: password
        - name: MONITORING_SERVICE_URL
          value: "http://monitoring-service:8082"
        - name: SON_ANALYSIS_INTERVAL
          value: "300"
        livenessProbe:
          httpGet:
            path: /health
            port: 9091
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 9091
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        resources:
          limits:
            cpu: "500m"
            memory: 256Mi
            ephemeral-storage: "1Gi"
          requests:
            cpu: "250m"
            memory: 128Mi
            ephemeral-storage: "500Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: ai-diagnostic
  namespace: basestation-platform
spec:
  selector:
    app: ai-diagnostic
  ports:
  - port: 9091
    targetPort: 9091
---
# API Gateway
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: basestation-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      automountServiceAccountToken: false
      containers:
      - name: api-gateway
        image: base-station-platform-api-gateway:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_DATA_REDIS_HOST
          value: redis
        - name: ROUTE_AUTH_URL
          value: http://auth-service:8084
        - name: ROUTE_BASESTATION_URL
          value: http://base-station-service:8081
        - name: ROUTE_MONITORING_URL
          value: http://monitoring-service:8082
        - name: ROUTE_NOTIFICATION_URL
          value: http://notification-service:8083
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: secret
        - name: SECURITY_INTERNAL_SECRET
          valueFrom:
            secretKeyRef:
              name: security-internal-secret
              key: secret
        - name: CORS_ALLOWED_ORIGINS
          value: http://frontend:80
        - name: MANAGEMENT_TRACING_ENDPOINT
          value: http://zipkin:9411
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 90
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 30
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
            ephemeral-storage: "2Gi"
          requests:
            cpu: "500m"
            memory: 512Mi
            ephemeral-storage: "1Gi"
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: basestation-platform
spec:
  type: NodePort
  selector:
    app: api-gateway
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30080
---
# Frontend
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: basestation-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      automountServiceAccountToken: false
      containers:
      - name: frontend
        image: base-station-platform-frontend:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: "500m"
            memory: 256Mi
            ephemeral-storage: "2Gi"
          requests:
            cpu: "250m"
            memory: 128Mi
            ephemeral-storage: "1Gi"
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: basestation-platform
spec:
  type: NodePort
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30000
---
# Edge Bridge (for MIPS device integration)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: edge-bridge
  namespace: basestation-platform
  labels:
    component: edge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: edge-bridge
  template:
    metadata:
      labels:
        app: edge-bridge
    spec:
      automountServiceAccountToken: false
      containers:
      - name: edge-bridge
        image: base-station-platform-edge-bridge:1.0.0
        imagePullPolicy: IfNotPresent
        env:
        - name: STATION_ID
          value: "BS-001"
        - name: CLOUD_BASE_URL
          value: http://api-gateway:8080
        - name: BRIDGE_USERNAME
          value: operator
        - name: BRIDGE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: edge-bridge-secret
              key: password
        - name: DEVICE_HOST
          value: device-simulator
        - name: DEVICE_PORT
          value: "9999"
        resources:
          limits:
            cpu: "250m"
            memory: 64Mi
            ephemeral-storage: "256Mi"
          requests:
            cpu: "100m"
            memory: 32Mi
            ephemeral-storage: "128Mi"
---
# Device Simulator (for testing edge-bridge without real hardware)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: device-simulator
  namespace: basestation-platform
  labels:
    component: edge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: device-simulator
  template:
    metadata:
      labels:
        app: device-simulator
    spec:
      automountServiceAccountToken: false
      containers:
      - name: device-simulator
        image: base-station-platform-device-simulator:1.0.0
        imagePullPolicy: IfNotPresent
        # Use virtual_station.py for HTTP/REST API metrics
        command: ["python", "virtual_station.py"]
        ports:
        - containerPort: 8090
        env:
        - name: STATION_ID
          value: "MIPS-BS-001"
        - name: STATION_NAME
          value: "Virtual-5G-Station-001"
        - name: API_GATEWAY_URL
          value: "http://api-gateway:8080"
        - name: AUTH_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: auth-credentials
              key: admin-password
        resources:
          limits:
            cpu: "100m"
            memory: 256Mi
            ephemeral-storage: "128Mi"
          requests:
            cpu: "50m"
            memory: 128Mi
            ephemeral-storage: "64Mi"
        livenessProbe:
          tcpSocket:
            port: 8090
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          tcpSocket:
            port: 8090
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: device-simulator
  namespace: basestation-platform
spec:
  selector:
    app: device-simulator
  ports:
  - port: 9999
    targetPort: 9999
