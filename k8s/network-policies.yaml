---
# ============================================================================
# Kubernetes Network Policies for Base Station Platform
# ============================================================================
# These policies implement defense-in-depth by restricting network traffic
# between pods to only what's necessary for the application to function.
#
# Security Benefits:
# - Prevents lateral movement in case of pod compromise
# - Enforces least-privilege network access
# - Reduces attack surface
#
# Requirements:
# - Kubernetes cluster with NetworkPolicy support (Calico, Cilium, Weave, etc.)
# - NOT supported by default in many cloud providers (enable CNI plugin)
#
# Testing:
#   kubectl get networkpolicies -n basestation-platform
#   kubectl describe networkpolicy <name> -n basestation-platform
# ============================================================================

# Default Deny All Ingress Traffic
# This policy denies all incoming traffic by default
# Other policies will explicitly allow required traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: basestation-platform
spec:
  podSelector: {}  # Applies to all pods in namespace
  policyTypes:
  - Ingress
---
# Allow Frontend to API Gateway
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-to-gateway
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from outside cluster (NodePort/LoadBalancer)
  - from:
    - podSelector: {}  # Allow from any pod (for health checks)
    ports:
    - protocol: TCP
      port: 80
  egress:
  # Allow DNS lookups
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to API Gateway
  - to:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 8080
---
# Allow API Gateway to Backend Services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from frontend
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8080
  # Allow from outside cluster (NodePort)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to backend services
  - to:
    - podSelector:
        matchLabels:
          app: auth-service
    ports:
    - protocol: TCP
      port: 8084
  - to:
    - podSelector:
        matchLabels:
          app: base-station-service
    ports:
    - protocol: TCP
      port: 8081
  - to:
    - podSelector:
        matchLabels:
          app: monitoring-service
    ports:
    - protocol: TCP
      port: 8082
  - to:
    - podSelector:
        matchLabels:
          app: notification-service
    ports:
    - protocol: TCP
      port: 8083
  # Allow to Redis (for rate limiting)
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  # Allow to Zipkin (for tracing)
  - to:
    - podSelector:
        matchLabels:
          app: zipkin
    ports:
    - protocol: TCP
      port: 9411
---
# Allow Auth Service to PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-service-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: auth-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from API Gateway
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 8084
  # Allow from Prometheus (metrics scraping)
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 8084
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # PostgreSQL (consolidated)
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # Zipkin (tracing)
  - to:
    - podSelector:
        matchLabels:
          app: zipkin
    ports:
    - protocol: TCP
      port: 9411
---
# Allow Base Station Service to PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: base-station-service-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: base-station-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from API Gateway
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 8081
  # Allow from Prometheus
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 8081
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # PostgreSQL (consolidated)
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # Zipkin
  - to:
    - podSelector:
        matchLabels:
          app: zipkin
    ports:
    - protocol: TCP
      port: 9411
---
# Allow Monitoring Service to MongoDB and AI Diagnostic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-service-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: monitoring-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from API Gateway
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 8082
  # Allow from Prometheus
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 8082
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # MongoDB
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  # RabbitMQ (consume events)
  - to:
    - podSelector:
        matchLabels:
          app: rabbitmq
    ports:
    - protocol: TCP
      port: 5672
  # AI Diagnostic Service
  - to:
    - podSelector:
        matchLabels:
          app: ai-diagnostic
    ports:
    - protocol: TCP
      port: 9091
  # Zipkin
  - to:
    - podSelector:
        matchLabels:
          app: zipkin
    ports:
    - protocol: TCP
      port: 9411
---
# Allow Notification Service to PostgreSQL and RabbitMQ
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: notification-service-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: notification-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from API Gateway
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 8083
  # Allow from Prometheus
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 8083
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # PostgreSQL (consolidated)
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # RabbitMQ
  - to:
    - podSelector:
        matchLabels:
          app: rabbitmq
    ports:
    - protocol: TCP
      port: 5672
  # Zipkin
  - to:
    - podSelector:
        matchLabels:
          app: zipkin
    ports:
    - protocol: TCP
      port: 9411
---
# AI Diagnostic Service Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ai-diagnostic-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: ai-diagnostic
  policyTypes:
  - Ingress
  ingress:
  # Allow from monitoring-service
  - from:
    - podSelector:
        matchLabels:
          app: monitoring-service
    ports:
    - protocol: TCP
      port: 9091
---
# Database Network Policies
# PostgreSQL (consolidated) - Multiple services can connect
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  # Allow from services that need PostgreSQL
  - from:
    - podSelector:
        matchLabels:
          app: auth-service
    - podSelector:
        matchLabels:
          app: base-station-service
    - podSelector:
        matchLabels:
          app: notification-service
    ports:
    - protocol: TCP
      port: 5432
  # Allow backup jobs
  - from:
    - podSelector:
        matchLabels:
          job-name: postgres-backup
    ports:
    - protocol: TCP
      port: 5432
---
# MongoDB - Only monitoring-service can connect
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: mongodb
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: monitoring-service
    ports:
    - protocol: TCP
      port: 27017
  - from:
    - podSelector:
        matchLabels:
          job-name: mongodb-backup
    ports:
    - protocol: TCP
      port: 27017
---
# Redis - Only API Gateway can connect
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 6379
---
# RabbitMQ - Only backend services can connect
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rabbitmq-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
  - Ingress
  ingress:
  # Allow from services that publish/consume messages
  - from:
    - podSelector:
        matchLabels:
          app: monitoring-service
    - podSelector:
        matchLabels:
          app: notification-service
    ports:
    - protocol: TCP
      port: 5672
  # Allow management UI access (NodePort)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 15672
---
# Monitoring Stack Network Policies
# Prometheus - Can scrape all services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow Grafana to query Prometheus
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 9090
  # Allow external access (NodePort)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 9090
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow scraping all application services
  - to:
    - podSelector:
        matchLabels:
          app: auth-service
    - podSelector:
        matchLabels:
          app: base-station-service
    - podSelector:
        matchLabels:
          app: monitoring-service
    - podSelector:
        matchLabels:
          app: notification-service
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 8081
    - protocol: TCP
      port: 8082
    - protocol: TCP
      port: 8083
    - protocol: TCP
      port: 8084
  # Kubernetes API for service discovery
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
---
# Grafana - Allow access from users and to Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow external access (NodePort)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 3000
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Query Prometheus
  - to:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
---
# Zipkin - Allow from all services (tracing)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: zipkin-policy
  namespace: basestation-platform
spec:
  podSelector:
    matchLabels:
      app: zipkin
  policyTypes:
  - Ingress
  ingress:
  # Allow from all application services
  - from:
    - podSelector:
        matchLabels:
          app: auth-service
    - podSelector:
        matchLabels:
          app: base-station-service
    - podSelector:
        matchLabels:
          app: monitoring-service
    - podSelector:
        matchLabels:
          app: notification-service
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 9411
  # Allow external access (NodePort UI)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 9411
