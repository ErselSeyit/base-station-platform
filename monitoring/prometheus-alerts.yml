groups:
  - name: service-availability
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} has been down for more than 1 minute."

      - alert: HighErrorRate
        expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (job) / sum(rate(http_server_requests_seconds_count[5m])) by (job) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ $labels.job }}"
          description: "{{ $labels.job }} has error rate > 5% (current: {{ $value | printf \"%.2f\" }}%)"

      - alert: CriticalErrorRate
        expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (job) / sum(rate(http_server_requests_seconds_count[5m])) by (job) > 0.1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Critical error rate on {{ $labels.job }}"
          description: "{{ $labels.job }} has error rate > 10% (current: {{ $value | printf \"%.2f\" }}%)"

  - name: performance
    rules:
      - alert: HighResponseLatency
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, job)) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High P95 latency on {{ $labels.job }}"
          description: "{{ $labels.job }} P95 response time > 1s (current: {{ $value | printf \"%.2f\" }}s)"

      - alert: CriticalResponseLatency
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, job)) > 3
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical P95 latency on {{ $labels.job }}"
          description: "{{ $labels.job }} P95 response time > 3s (current: {{ $value | printf \"%.2f\" }}s)"

      - alert: HighRequestRate
        expr: sum(rate(http_server_requests_seconds_count[5m])) by (job) > 100
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "High request rate on {{ $labels.job }}"
          description: "{{ $labels.job }} receiving > 100 req/s (current: {{ $value | printf \"%.0f\" }})"

  - name: jvm-memory
    rules:
      - alert: HighHeapUsage
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High heap usage on {{ $labels.job }}"
          description: "{{ $labels.job }} heap usage > 80% (current: {{ $value | printf \"%.0f\" }}%)"

      - alert: CriticalHeapUsage
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} > 0.95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical heap usage on {{ $labels.job }}"
          description: "{{ $labels.job }} heap usage > 95% - OOM imminent!"

      - alert: FrequentGC
        expr: rate(jvm_gc_pause_seconds_count[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Frequent GC on {{ $labels.job }}"
          description: "{{ $labels.job }} GC running > 0.5 times/second"

      - alert: LongGCPause
        expr: rate(jvm_gc_pause_seconds_sum[5m]) / rate(jvm_gc_pause_seconds_count[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Long GC pauses on {{ $labels.job }}"
          description: "{{ $labels.job }} average GC pause > 500ms"

  - name: database
    rules:
      - alert: DatabaseConnectionPoolExhausted
        expr: hikaricp_connections_pending > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Connection pool exhausted on {{ $labels.job }}"
          description: "{{ $labels.job }} has {{ $value }} pending connections"

      - alert: HighDatabaseConnections
        expr: hikaricp_connections_active / hikaricp_connections_max > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High DB connection usage on {{ $labels.job }}"
          description: "{{ $labels.job }} using > 80% of connection pool"

  - name: threads
    rules:
      - alert: HighThreadCount
        expr: jvm_threads_live_threads > 200
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High thread count on {{ $labels.job }}"
          description: "{{ $labels.job }} has {{ $value }} live threads"

      - alert: DeadlockedThreads
        expr: jvm_threads_deadlocked_threads > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Deadlocked threads detected on {{ $labels.job }}"
          description: "{{ $labels.job }} has {{ $value }} deadlocked threads!"
